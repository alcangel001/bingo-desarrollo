{% extends 'bingo_app/base.html' %}
{% load static %}

{% block title %}Dice Battle - Partida {{ room_code }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dice_table.css' %}">
{% endblock %}

{% block content %}
<!-- Barra Superior -->
<header class="game-header">
    <div class="header-left">
        <button class="menu-btn" onclick="window.location.href='{% url 'lobby' %}'">‚ò∞</button>
        <button class="friends-btn">üë•</button>
        <button class="settings-btn">‚öôÔ∏è</button>
    </div>
    <div class="header-right">
        <div class="balance-display">
            <span class="coin-icon">üí∞</span>
            <span id="user-balance">${{ user.credit_balance }}</span>
        </div>
    </div>
</header>

<!-- Mesa de Juego -->
<div class="game-table-container" id="table-container">
    
    <!-- Jugador 1 (Arriba) -->
    <div class="player-seat player-top" id="player-1">
        <div class="player-avatar">
            <img src="" alt="Avatar" id="avatar-1" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2264%22 height=%2264%22%3E%3Ccircle cx=%2232%22 cy=%2232%22 r=%2230%22 fill=%22%239b59b6%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22 font-size=%2224%22 font-weight=%22bold%22%3E?%3C/text%3E%3C/svg%3E';">
            <div class="player-status" id="status-1">‚óè</div>
        </div>
        <div class="player-info">
            <div class="player-name" id="name-1">Esperando...</div>
            <div class="health-bar-container">
                <div class="health-bar-fill" id="health-bar-1"></div>
            </div>
            <div class="player-stack" id="stack-1">$0</div>
        </div>
        <div class="player-dice" id="dice-1">
            <div class="dice-value">-</div>
            <div class="dice-3d-container" id="dice-3d-1" style="display: none;">
                <div class="scene">
                    <div class="cube" id="cube-1-1">
                        <div class="cube__face face-1"><div class="dot"></div></div>
                        <div class="cube__face face-2"><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-3"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-4"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-5"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-6"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                    </div>
                </div>
                <div class="scene">
                    <div class="cube" id="cube-1-2">
                        <div class="cube__face face-1"><div class="dot"></div></div>
                        <div class="cube__face face-2"><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-3"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-4"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-5"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-6"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Jugador 2 (Izquierda) -->
    <div class="player-seat player-left" id="player-2">
        <div class="player-avatar">
            <img src="" alt="Avatar" id="avatar-2" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2264%22 height=%2264%22%3E%3Ccircle cx=%2232%22 cy=%2232%22 r=%2230%22 fill=%22%239b59b6%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22 font-size=%2224%22 font-weight=%22bold%22%3E?%3C/text%3E%3C/svg%3E';">
            <div class="player-status" id="status-2">‚óè</div>
        </div>
        <div class="player-info">
            <div class="player-name" id="name-2">Esperando...</div>
            <div class="health-bar-container">
                <div class="health-bar-fill" id="health-bar-2"></div>
            </div>
            <div class="player-stack" id="stack-2">$0</div>
        </div>
        <div class="player-dice" id="dice-2">
            <div class="dice-value">-</div>
            <div class="dice-3d-container" id="dice-3d-2" style="display: none;">
                <div class="scene">
                    <div class="cube" id="cube-2-1">
                        <div class="cube__face face-1"><div class="dot"></div></div>
                        <div class="cube__face face-2"><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-3"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-4"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-5"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-6"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                    </div>
                </div>
                <div class="scene">
                    <div class="cube" id="cube-2-2">
                        <div class="cube__face face-1"><div class="dot"></div></div>
                        <div class="cube__face face-2"><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-3"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-4"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-5"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-6"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Jugador 3 (Derecha) -->
    <div class="player-seat player-right" id="player-3">
        <div class="player-avatar">
            <img src="" alt="Avatar" id="avatar-3" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2264%22 height=%2264%22%3E%3Ccircle cx=%2232%22 cy=%2232%22 r=%2230%22 fill=%22%239b59b6%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22 font-size=%2224%22 font-weight=%22bold%22%3E?%3C/text%3E%3C/svg%3E';">
            <div class="player-status" id="status-3">‚óè</div>
        </div>
        <div class="player-info">
            <div class="player-name" id="name-3">Esperando...</div>
            <div class="health-bar-container">
                <div class="health-bar-fill" id="health-bar-3"></div>
            </div>
            <div class="player-stack" id="stack-3">$0</div>
        </div>
        <div class="player-dice" id="dice-3">
            <div class="dice-value">-</div>
            <div class="dice-3d-container" id="dice-3d-3" style="display: none;">
                <div class="scene">
                    <div class="cube" id="cube-3-1">
                        <div class="cube__face face-1"><div class="dot"></div></div>
                        <div class="cube__face face-2"><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-3"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-4"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-5"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-6"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                    </div>
                </div>
                <div class="scene">
                    <div class="cube" id="cube-3-2">
                        <div class="cube__face face-1"><div class="dot"></div></div>
                        <div class="cube__face face-2"><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-3"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-4"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-5"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="cube__face face-6"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Centro de la Mesa - Premio -->
    <div class="table-center" id="table-center">
        <div class="prize-display" id="prize-display">
            <div class="prize-label">PREMIO</div>
            <div class="prize-amount" id="prize-amount">${{ dice_game.final_prize|default:"0.00" }}</div>
            <div class="prize-multiplier" id="prize-multiplier">{{ dice_game.multiplier|default:"1x" }}</div>
        </div>
        
        <!-- Animaci√≥n de Spin -->
        <div class="spin-animation" id="spin-animation" style="display: none;">
            <div class="spinning-wheel">üé∞</div>
        </div>
    </div>

    <!-- Mesa Circular (Fondo) -->
    <div class="table-surface" id="table-surface"></div>
</div>

<!-- Contenedor de Animaci√≥n de Dados -->
<div id="dice-container">
    <div class="dice-label">üé≤ Lanzando Dados...</div>
    <div class="dice-pair">
        <div class="die-box dice-rolling" id="die-1">?</div>
        <div class="die-box dice-rolling" id="die-2">?</div>
    </div>
</div>

<!-- Modal de Ruleta Animada (Slot Machine) -->
<div id="multiplier-slot-modal" class="multiplier-slot-modal" style="display: none;">
    <div class="slot-modal-content">
        <div class="slot-modal-header">
            <h2>üé∞ Determinando Multiplicador</h2>
        </div>
        <div class="slot-machine-container">
            <div class="slot-reel" id="slot-reel">
                <div class="slot-item">2x</div>
                <div class="slot-item">3x</div>
                <div class="slot-item">5x</div>
                <div class="slot-item">10x</div>
                <div class="slot-item">25x</div>
                <div class="slot-item">100x</div>
                <div class="slot-item">500x</div>
                <div class="slot-item">1000x</div>
                <!-- Duplicar items para efecto de loop infinito -->
                <div class="slot-item">2x</div>
                <div class="slot-item">3x</div>
                <div class="slot-item">5x</div>
                <div class="slot-item">10x</div>
                <div class="slot-item">25x</div>
                <div class="slot-item">100x</div>
                <div class="slot-item">500x</div>
                <div class="slot-item">1000x</div>
            </div>
        </div>
        <div class="slot-result" id="slot-result" style="display: none;">
            <div class="slot-result-multiplier" id="slot-result-multiplier"></div>
            <div class="slot-result-prize" id="slot-result-prize"></div>
        </div>
    </div>
</div>

<!-- Panel de Control Inferior -->
<div class="game-controls">
    <div class="round-info">
        <div class="round-label">Ronda</div>
        <div class="round-number" id="round-number">1</div>
    </div>
    
    <button class="roll-dice-btn" id="roll-dice-btn" disabled>
        <span class="dice-icon">üé≤</span>
        <span class="btn-text">LANZAR DADOS</span>
    </button>
    
    <div class="game-status" id="game-status">
        {% if dice_game.status == 'WAITING' %}
            Esperando jugadores...
        {% elif dice_game.status == 'SPINNING' %}
            Determinando premio...
        {% elif dice_game.status == 'PLAYING' %}
            En juego...
        {% else %}
            Partida terminada
        {% endif %}
    </div>
</div>

<script>
    const ROOM_CODE = '{{ room_code }}';
    const USER_ID = {{ user.id }};
    const CURRENT_MULTIPLIER = '{{ dice_game.multiplier|default:"2x" }}';
    
    // Datos iniciales de los jugadores desde el backend
    const INITIAL_PLAYERS = [
        {% for player in players %}
        {
            user_id: {{ player.user.id }},
            username: '{{ player.user.username }}',
            avatar_url: '{% if player.user.get_avatar_url %}{{ player.user.get_avatar_url }}{% else %}data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2264%22 height=%2264%22%3E%3Ccircle cx=%2232%22 cy=%2232%22 r=%2230%22 fill=%22%239b59b6%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22 font-size=%2224%22 font-weight=%22bold%22%3E?%3C/text%3E%3C/svg%3E{% endif %}',
            lives: {{ player.lives }},
            is_eliminated: {{ player.is_eliminated|lower }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Inicializar jugadores cuando se carga la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof INITIAL_PLAYERS !== 'undefined' && INITIAL_PLAYERS.length > 0) {
            INITIAL_PLAYERS.forEach((player, index) => {
                const seatIndex = index + 1;
                const nameEl = document.getElementById(`name-${seatIndex}`);
                const avatarEl = document.getElementById(`avatar-${seatIndex}`);
                const statusEl = document.getElementById(`status-${seatIndex}`);
                
                if (nameEl) nameEl.textContent = player.username;
                if (avatarEl) avatarEl.src = player.avatar_url;
                if (statusEl) {
                    statusEl.style.color = player.is_eliminated ? '#ff4444' : '#44ff44';
                    statusEl.textContent = player.is_eliminated ? '‚úï' : '‚óè';
                }
            });
        }
        
        // Verificar estado del juego y habilitar bot√≥n si est√° en PLAYING
        const gameStatus = '{{ dice_game.status }}';
        const rollBtn = document.getElementById('roll-dice-btn');
        const gameStatusEl = document.getElementById('game-status');
        
        if (gameStatus === 'PLAYING' && rollBtn) {
            rollBtn.disabled = false;
            if (gameStatusEl) gameStatusEl.textContent = 'En juego - ¬°Lanza los dados!';
        } else if (gameStatus === 'SPINNING' && rollBtn) {
            rollBtn.disabled = true;
            if (gameStatusEl) gameStatusEl.textContent = 'Determinando premio...';
            
            // Si ya hay multiplicador, mostrar animaci√≥n
            const multiplier = '{{ dice_game.multiplier|default:"" }}';
            const finalPrize = '{{ dice_game.final_prize|default:"0" }}';
            
            if (multiplier && multiplier !== '1x' && multiplier !== '') {
                // Ya se determin√≥ el premio, iniciar animaci√≥n con sincronizaci√≥n temporal
                const startedAt = '{{ dice_game.started_at|date:"c" }}' || null;
                setTimeout(() => {
                    if (typeof showPrizeSpinAnimation === 'function') {
                        showPrizeSpinAnimation(multiplier, finalPrize, startedAt);
                    }
                }, 500);
            }
            
            // Fallback: si despu√©s de 15 segundos a√∫n estamos en SPINNING, habilitar bot√≥n
            setTimeout(() => {
                if (rollBtn && rollBtn.disabled) {
                    console.log('‚è±Ô∏è Fallback: habilitando bot√≥n despu√©s de timeout');
                    rollBtn.disabled = false;
                    if (gameStatusEl) gameStatusEl.textContent = 'En juego - ¬°Lanza los dados!';
                }
            }, 15000);
        }
    });
</script>
<script src="{% static 'js/dice_table_colors.js' %}"></script>
<script src="{% static 'js/dice_websocket.js' %}"></script>
<script src="{% static 'js/dice_game.js' %}"></script>
<script>
    // Aplicar colores seg√∫n el multiplicador
    if (CURRENT_MULTIPLIER) {
        applyPrizeColors(CURRENT_MULTIPLIER);
    }
</script>
{% endblock %}

