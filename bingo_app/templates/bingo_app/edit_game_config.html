{% extends "bingo_app/base.html" %}

{% block extra_css %}
<style>
    .form-label,
    .form-control,
    .form-text,
    .text-muted,
    .card-body,
    .card-header h3,
    .progressive-prize-container h5,
    .progressive-prize-container p,
    .error-message {
        color: #212529 !important;
    }

    .form-control::placeholder {
        color: #6c757d !important;
        opacity: 1;
    }

    .input-group-text {
        color: #495057 !important;
        background-color: #e9ecef !important;
    }

    .progressive-prize-container {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid rgba(0,0,0,0.05);
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .prize-tier {
        background-color: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid rgba(0,0,0,0.1);
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    
    .prize-tier:hover {
        transform: translateX(3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .add-tier-btn {
        margin-top: 15px;
    }

    .info-alert {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border-left: 4px solid #2196f3;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .remove-tier-btn {
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header">
                    <h3 class="mb-0 text-white">
                        <i class="fas fa-edit me-2"></i>Editar Configuración de Juego
                    </h3>
                </div>
                
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <!-- Mostrar errores generales -->
                    {% if form.errors %}
                    <div class="alert alert-danger mx-3 mt-3">
                        <strong>Errores:</strong>
                        <ul class="mb-0">
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <div class="card-body text-dark">
                        <!-- Información del juego -->
                        <div class="info-alert">
                            <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>Información del Juego</h6>
                            <p class="mb-1"><strong>Nombre:</strong> {{ game.name }}</p>
                            <p class="mb-1"><strong>Premio Base Actual:</strong> {{ game.base_prize }} créditos</p>
                            <p class="mb-0"><strong>Cartones Vendidos:</strong> {{ game.total_cards_sold }}</p>
                            {% if game.total_cards_sold > 0 %}
                            <p class="text-warning mt-2 mb-0">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                Los nuevos niveles deben requerir más de {{ game.total_cards_sold }} cartones
                            </p>
                            {% endif %}
                        </div>

                        <!-- Ajuste de Premio Base -->
                        <div class="card mb-4" style="border: 2px solid #28a745;">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-dollar-sign me-2"></i>Ajustar Premio Base
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-end">
                                    <div class="col-md-6 mb-3">
                                        <label for="id_new_base_prize" class="form-label">
                                            <strong>Nuevo Premio Base (créditos)</strong>
                                        </label>
                                        <input type="number" 
                                               class="form-control {% if form.new_base_prize.errors %}is-invalid{% endif %}" 
                                               id="id_new_base_prize" 
                                               name="new_base_prize" 
                                               value="{{ form.new_base_prize.value|default:game.base_prize }}" 
                                               min="0" 
                                               step="1"
                                               oninput="updatePrizePreview()">
                                        {% for error in form.new_base_prize.errors %}
                                            <div class="error-message text-danger">{{ error }}</div>
                                        {% endfor %}
                                        <div class="form-text">
                                            <small>Deja el valor actual ({{ game.base_prize }}) si no quieres cambiar el premio base</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div id="prize-preview" class="alert alert-info mb-0">
                                            <strong class="fs-6">Vista previa:</strong><br>
                                            <span id="preview-text" class="fw-bold fs-5">Sin cambios</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-warning mb-0 border-warning border-2">
                                    <strong class="fs-6">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Nota importante:
                                    </strong>
                                    <p class="mb-0 mt-2 fw-bold">
                                        Si aumentas el premio, se bloquearán créditos adicionales de tu saldo. 
                                        Si lo reduces, se desbloquearán créditos.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Nombre y Contraseña -->
                        <div class="row mb-4">
                            <div class="col-md-8 mb-3">
                                <label for="id_name" class="form-label">Nombre de la partida*</label>
                                <input type="text" class="form-control {% if form.name.errors %}is-invalid{% endif %}" 
                                       id="id_name" name="name" value="{{ form.name.value|default:game.name }}" required>
                                {% for error in form.name.errors %}
                                    <div class="error-message">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="id_password" class="form-label">Contraseña (opcional)</label>
                                <input type="password" class="form-control" id="id_password" name="password"
                                       value="{{ form.password.value|default:game.password }}">
                                <div class="form-text">Deja en blanco para eliminar la contraseña</div>
                            </div>
                        </div>

                        <!-- Premios Progresivos -->
                        <div class="progressive-prize-container">
                            <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i>Premios Progresivos</h5>
                            <p class="text-muted">Configura aumentos al premio base cuando se alcancen ciertos números de cartones vendidos</p>
                            {% if game.total_cards_sold > 0 %}
                            <div class="alert alert-warning">
                                <i class="fas fa-info-circle me-2"></i>
                                Ya se han vendido {{ game.total_cards_sold }} cartones. Los nuevos niveles deben requerir más de {{ game.total_cards_sold }} cartones.
                            </div>
                            {% endif %}
                            
                            <div id="prize-tiers-container">
                                <!-- Los niveles se cargarán dinámicamente desde JavaScript -->
                                {% if game.progressive_prizes %}
                                    {% for prize in game.progressive_prizes %}
                                    <div class="prize-tier">
                                        <div class="row">
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label">Cartones requeridos{% if forloop.first %}*{% endif %}</label>
                                                <input type="number" class="form-control progressive-target" 
                                                       name="progressive_target[]" min="{{ game.total_cards_sold|add:1 }}" 
                                                       value="{{ prize.target }}" placeholder="Ej: 10" {% if forloop.first %}required{% endif %}>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label">Aumento de premio{% if forloop.first %}*{% endif %}</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control progressive-prize" 
                                                           name="progressive_prize[]" min="1" step="1" 
                                                           value="{{ prize.prize }}" placeholder="Ej: 5" {% if forloop.first %}required{% endif %}>
                                                    <span class="input-group-text">créditos</span>
                                                </div>
                                            </div>
                                        </div>
                                        {% if not forloop.first %}
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-tier-btn">
                                            <i class="fas fa-trash-alt me-1"></i> Eliminar
                                        </button>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <!-- Tier 1 (requerido si no hay niveles) -->
                                    <div class="prize-tier">
                                        <div class="row">
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label">Cartones requeridos</label>
                                                <input type="number" class="form-control progressive-target" 
                                                       name="progressive_target[]" min="{{ game.total_cards_sold|add:1 }}" 
                                                       placeholder="Ej: 10">
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label">Aumento de premio</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control progressive-prize" 
                                                           name="progressive_prize[]" min="1" step="1" placeholder="Ej: 5">
                                                    <span class="input-group-text">créditos</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <button type="button" class="btn btn-outline-primary add-tier-btn" id="add-tier-btn">
                                <i class="fas fa-plus-circle me-1"></i> Añadir otro nivel
                            </button>
                        </div>

                        <!-- Configuración adicional -->
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label for="id_auto_call_interval" class="form-label">Intervalo llamadas (segundos)*</label>
                                <input type="number" class="form-control {% if form.auto_call_interval.errors %}is-invalid{% endif %}" 
                                       id="id_auto_call_interval" name="auto_call_interval" min="1" max="60" 
                                       value="{{ form.auto_call_interval.value|default:game.auto_call_interval }}" required>
                                {% for error in form.auto_call_interval.errors %}
                                    <div class="error-message">{{ error }}</div>
                                {% endfor %}
                                <div class="form-text">Tiempo entre llamadas automáticas</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" name="allows_printable_cards" 
                                           id="id_allows_printable_cards" {% if game.allows_printable_cards %}checked{% endif %}>
                                    <label class="form-check-label" for="id_allows_printable_cards">
                                        Permitir cartones físicos/imprimibles
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botones de acción -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-3">
                            <a href="{% url 'game_room' game.id %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Guardar Cambios
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Función para actualizar la vista previa del premio
function updatePrizePreview() {
    const newPrizeInput = document.getElementById('id_new_base_prize');
    const currentPrize = {{ game.base_prize }};
    const newPrize = parseFloat(newPrizeInput.value) || currentPrize;
    const diferencia = newPrize - currentPrize;
    const previewText = document.getElementById('preview-text');
    const previewDiv = document.getElementById('prize-preview');
    
    if (diferencia === 0) {
        previewText.innerHTML = '<span class="fw-bold fs-5">Sin cambios</span>';
        previewDiv.className = 'alert alert-info mb-0';
    } else if (diferencia > 0) {
        previewText.innerHTML = `
            <span class="text-success fw-bold fs-4">+${diferencia} créditos</span><br>
            <span class="fw-bold mt-2 d-block">Se bloquearán ${diferencia} créditos adicionales</span>
        `;
        previewDiv.className = 'alert alert-success mb-0 border-success border-2';
    } else {
        previewText.innerHTML = `
            <span class="text-warning fw-bold fs-4">${diferencia} créditos</span><br>
            <span class="fw-bold mt-2 d-block">Se desbloquearán ${Math.abs(diferencia)} créditos</span>
        `;
        previewDiv.className = 'alert alert-warning mb-0 border-warning border-2';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const tiersContainer = document.getElementById('prize-tiers-container');
    const addTierBtn = document.getElementById('add-tier-btn');
    const form = document.querySelector('form');
    const minCards = {{ game.total_cards_sold|add:1 }};
    
    // Inicializar vista previa
    updatePrizePreview();

    // Añadir nuevo nivel
    addTierBtn.addEventListener('click', function() {
        const newTier = document.createElement('div');
        newTier.className = 'prize-tier mt-3';
        newTier.innerHTML = `
            <div class="row">
                <div class="col-md-6 mb-2">
                    <label class="form-label">Cartones requeridos</label>
                    <input type="number" class="form-control progressive-target" 
                           name="progressive_target[]" min="${minCards}" placeholder="Ej: 20">
                </div>
                <div class="col-md-6 mb-2">
                    <label class="form-label">Aumento de premio</label>
                    <div class="input-group">
                        <span class="input-group-text">+</span>
                        <input type="number" class="form-control progressive-prize" 
                               name="progressive_prize[]" min="1" step="1" placeholder="Ej: 10">
                        <span class="input-group-text">créditos</span>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger remove-tier-btn">
                <i class="fas fa-trash-alt me-1"></i> Eliminar
            </button>
        `;
        tiersContainer.appendChild(newTier);
        
        // Añadir evento al botón de eliminar
        newTier.querySelector('.remove-tier-btn').addEventListener('click', function() {
            tiersContainer.removeChild(newTier);
        });
    });

    // Eliminar niveles (event delegation)
    tiersContainer.addEventListener('click', function(e) {
        if (e.target.closest('.remove-tier-btn')) {
            const tier = e.target.closest('.prize-tier');
            if (tiersContainer.children.length > 1) {
                tiersContainer.removeChild(tier);
            } else {
                alert('Debes mantener al menos un nivel o eliminar todos si no quieres niveles progresivos.');
            }
        }
    });

    // Validar antes de enviar
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        event.stopPropagation();
        
        // Validar premios progresivos
        const targets = form.querySelectorAll('.progressive-target');
        const prizes = form.querySelectorAll('.progressive-prize');
        let progressivePrizes = [];
        let isValid = true;
        
        for (let i = 0; i < targets.length; i++) {
            if (targets[i].value && prizes[i].value) {
                const target = parseInt(targets[i].value);
                const prize = parseFloat(prizes[i].value);
                
                if (target <= {{ game.total_cards_sold }}) {
                    targets[i].classList.add('is-invalid');
                    alert(`El nivel de ${target} cartones debe ser mayor a los cartones ya vendidos ({{ game.total_cards_sold }})`);
                    isValid = false;
                    break;
                }
                
                progressivePrizes.push({
                    target: target,
                    prize: prize
                });
            }
        }
        
        // Ordenar por target
        progressivePrizes.sort((a, b) => a.target - b.target);
        
        // Crear campo hidden con el JSON
        let existingHidden = form.querySelector('input[name="progressive_prizes_json"]');
        if (!existingHidden) {
            existingHidden = document.createElement('input');
            existingHidden.type = 'hidden';
            existingHidden.name = 'progressive_prizes_json';
            form.appendChild(existingHidden);
        }
        existingHidden.value = JSON.stringify(progressivePrizes);
        
        if (isValid) {
            form.submit();
        }
    });
});
</script>
{% endblock %}

